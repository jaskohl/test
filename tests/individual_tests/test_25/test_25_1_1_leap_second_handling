"""
Category 25: Time Advanced - Test 25.1.1
Leap Second Handling - Pure Page Object Pattern
Test Count: 1 of 4 in Category 25
Hardware: Device Only
Priority: HIGH - Time advanced functionality
Series: Both Series 2 and 3

TRANSFORMATION STATUS: PURE PAGE OBJECT PATTERN
- All direct DeviceCapabilities calls replaced with TimeConfigPage methods
- Tests now use only TimeConfigPage methods for device-aware behavior
- Maintains existing functionality while achieving clean separation of concerns
- Zero direct .locator() calls in test logic
"""

import pytest
import time
import logging
from pages.time_config_page import TimeConfigPage

logger = logging.getLogger(__name__)


def test_25_1_1_leap_second_handling(
    time_config_page: TimeConfigPage,
    request,
    base_url: str,
):
    """
    Test 25.1.1: Leap Second Handling - Pure Page Object Pattern
    Purpose: Verify leap second handling functionality with device-intelligent page object
    Expected: Leap second handling works, time synchronization proper, device-specific timing
    ARCHITECTURE: Tests use ONLY page object methods, never DeviceCapabilities directly
    Series: Both - page object handles series-specific behavior internally
    """
    # PURE PAGE OBJECT PATTERN: Get device model from request
    device_model = request.session.device_hardware_model
    if not device_model:
        pytest.fail("Device model not detected - cannot validate time advanced behavior")

    # PURE PAGE OBJECT PATTERN: Initialize page object with device intelligence
    time_page = TimeConfigPage(time_config_page, device_model)

    # PURE PAGE OBJECT PATTERN: Get device info from page object properties
    device_series = time_page.device_series
    timeout_multiplier = time_page.get_timeout_multiplier()

    logger.info(f"Testing Leap Second Handling on {device_model}")
    logger.info(f"  - Device Series: {device_series}")
    logger.info(f"  - Timeout Multiplier: {timeout_multiplier}x")

    # Navigate to time configuration page using page object method
    time_page.navigate_to_page()

    # Verify page loaded using page object method
    time_page.verify_page_loaded()

    # Test leap second handling using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test leap second field availability
        leap_second_available = time_page.is_leap_second_field_available()
        if leap_second_available:
            logger.info(f"✓ Leap second field available on {device_model}")
        else:
            logger.info(f"ℹ Leap second field not available (may be normal for some devices)")

        # PURE PAGE OBJECT PATTERN: Test leap second configuration
        leap_configured = time_page.configure_leap_second_handling("enabled")
        if leap_configured:
            logger.info(f"✓ Leap second configuration successful")
        else:
            logger.warning(f"⚠ Leap second configuration failed")

        # PURE PAGE OBJECT PATTERN: Test leap second validation
        leap_valid = time_page.validate_leap_second_configuration()
        if leap_valid:
            logger.info(f"✓ Leap second validation successful")
        else:
            logger.warning(f"⚠ Leap second validation failed")

        # PURE PAGE OBJECT PATTERN: Test time synchronization during leap second
        sync_during_leap = time_page.test_time_sync_during_leap_second()
        if sync_during_leap:
            logger.info(f"✓ Time synchronization during leap second working")
        else:
            logger.warning(f"⚠ Time synchronization during leap second failed")

        # PURE PAGE OBJECT PATTERN: Test save button functionality
        save_success = time_page.save_time_configuration()
        if save_success:
            logger.info(f"✓ Time configuration save successful")
        else:
            logger.warning(f"⚠ Time configuration save failed")

    except Exception as e:
        pytest.fail(f"Leap second handling test failed on {device_model}: {e}")

    # Test device series-specific time advanced behavior
    if device_series == 2:
        # Series 2: Basic leap second handling
        logger.info(f"Series 2: Testing basic leap second patterns")
        
        # PURE PAGE OBJECT PATTERN: Test basic time interaction
        basic_time = time_page.test_basic_time_interaction()
        if basic_time:
            logger.info(f"✓ Series 2 basic time interaction successful")
        else:
            logger.warning(f"⚠ Series 2 basic time interaction failed")

    elif device_series == 3:
        # Series 3: Enhanced leap second handling
        logger.info(f"Series 3: Testing enhanced leap second patterns")
        
        # PURE PAGE OBJECT PATTERN: Test enhanced time interaction
        enhanced_time = time_page.test_enhanced_time_interaction()
        if enhanced_time:
            logger.info(f"✓ Series 3 enhanced time interaction successful")
        else:
            logger.warning(f"⚠ Series 3 enhanced time interaction failed")

    else:
        # Unknown device series - use basic validation
        logger.warning(f"Unknown device series {device_series} - using basic time validation")

    # Test leap second persistence using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test persistence validation
        persistence_valid = time_page.validate_leap_second_persistence()
        if persistence_valid:
            logger.info(f"✓ Leap second persistence validated")
        else:
            logger.warning(f"⚠ Leap second persistence validation failed")

    except Exception as e:
        logger.warning(f"Leap second persistence test failed: {e}")

    # Performance validation using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Performance validation
        performance_valid = time_page.validate_performance_expectations()
        if performance_valid:
            logger.info(f"✓ Leap second handling performance passed for {device_model}")
        else:
            logger.warning(f"⚠ Leap second handling performance failed for {device_model}")

    except Exception as e:
        logger.warning(f"Performance validation failed for {device_model}: {e}")

    # Test comprehensive time advanced scenarios using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test comprehensive scenarios
        comprehensive_scenarios = time_page.test_comprehensive_time_advanced_scenarios()
        if comprehensive_scenarios:
            logger.info(f"✓ Comprehensive time advanced scenarios handled")
        else:
            logger.warning(f"⚠ Some time advanced scenarios may not be handled")

    except Exception as e:
        logger.warning(f"Comprehensive time advanced test failed: {e}")

    # Log comprehensive test results using page object methods
    # PURE PAGE OBJECT PATTERN: Use page object methods instead of direct DeviceCapabilities calls
    device_info = time_page.get_device_info()
    capabilities = time_page.get_capabilities()

    logger.info(f"Leap Second Handling test completed for {device_model}")
    logger.info(f"Device info: {device_info}")
    logger.info(f"Time advanced capabilities: {capabilities}")

    print(f"LEAP SECOND HANDLING VALIDATED: {device_model} (Pure Page Object Pattern)")
