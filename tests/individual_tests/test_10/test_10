"""
Category 10: Dashboard Data Extraction - Test 10.1.1
All Tables Present - Pure Page Object Pattern
Test Count: 1 of 10 in Category 10
Hardware: Device Only
Priority: HIGH - Dashboard data extraction functionality
Series: Both Series 2 and 3

TRANSFORMATION STATUS: PURE PAGE OBJECT PATTERN
- All direct DeviceCapabilities calls replaced with DashboardPage methods
- Tests now use only DashboardPage methods for device-aware behavior
- Maintains existing functionality while achieving clean separation of concerns
- Zero direct .locator() calls in test logic
"""

import pytest
import time
import logging
from pages.dashboard_page import DashboardPage

logger = logging.getLogger(__name__)


def test_10_1_1_all_tables_present(
    dashboard_page: DashboardPage,
    request,
    base_url: str,
):
    """
    Test 10.1.1: All Tables Present - Pure Page Object Pattern
    Purpose: Verify dashboard table presence with device-intelligent page object
    Expected: All tables present, data extractable, device-specific timing
    ARCHITECTURE: Tests use ONLY page object methods, never DeviceCapabilities directly
    Series: Both - page object handles series-specific behavior internally
    """
    # PURE PAGE OBJECT PATTERN: Get device model from request
    device_model = request.session.device_hardware_model
    if not device_model:
        pytest.fail("Device model not detected - cannot validate dashboard behavior")

    # PURE PAGE OBJECT PATTERN: Initialize page object with device intelligence
    dashboard = DashboardPage(dashboard_page, device_model)

    # PURE PAGE OBJECT PATTERN: Get device info from page object properties
    device_series = dashboard.device_series
    timeout_multiplier = dashboard.get_timeout_multiplier()

    logger.info(f"Testing All Tables Present on {device_model}")
    logger.info(f"  - Device Series: {device_series}")
    logger.info(f"  - Timeout Multiplier: {timeout_multiplier}x")

    # Navigate to dashboard page using page object method
    dashboard.navigate_to_page()

    # Verify page loaded using page object method
    dashboard.verify_page_loaded()

    # Test dashboard table presence using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test table count validation
        table_count = dashboard.get_table_count()
        expected_tables = 4  # Standard dashboard has 4 tables

        if table_count >= expected_tables:
            logger.info(f"✓ Dashboard tables present: {table_count}/{expected_tables}")
        else:
            logger.warning(f"⚠ Dashboard tables missing: {table_count}/{expected_tables}")

        # PURE PAGE OBJECT PATTERN: Test table data extraction
        page_data = dashboard.get_page_data()
        if page_data:
            logger.info(f"✓ Dashboard page data extracted: {len(page_data)} sections")
        else:
            logger.warning(f"⚠ Dashboard page data extraction failed")

        # PURE PAGE OBJECT PATTERN: Test time sync data extraction
        time_data = dashboard.get_time_sync_data()
        if time_data:
            logger.info(f"✓ Time sync data extracted: {len(time_data)} fields")
        else:
            logger.warning(f"⚠ Time sync data extraction failed")

        # PURE PAGE OBJECT PATTERN: Test GNSS data extraction
        gnss_data = dashboard.get_gnss_data()
        if gnss_data:
            logger.info(f"✓ GNSS data extracted: {len(gnss_data)} fields")
        else:
            logger.warning(f"⚠ GNSS data extraction failed")

        # PURE PAGE OBJECT PATTERN: Test device info extraction
        device_info = dashboard.get_device_info()
        if device_info:
            logger.info(f"✓ Device info extracted: {len(device_info)} fields")
        else:
            logger.warning(f"⚠ Device info extraction failed")

        # PURE PAGE OBJECT PATTERN: Test satellite list extraction
        satellite_list = dashboard.get_satellite_list()
        if satellite_list:
            logger.info(f"✓ Satellite list extracted: {len(satellite_list)} satellites")
        else:
            logger.warning(f"⚠ Satellite list extraction failed")

    except Exception as e:
        pytest.fail(f"Dashboard tables test failed on {device_model}: {e}")

    # Test device series-specific dashboard behavior
    if device_series == 2:
        # Series 2: Basic dashboard structure
        logger.info(f"Series 2: Testing basic dashboard structure")
        
        # PURE PAGE OBJECT PATTERN: Test basic dashboard interaction
        basic_dashboard = dashboard.test_basic_dashboard_interaction()
        if basic_dashboard:
            logger.info(f"✓ Series 2 basic dashboard interaction successful")
        else:
            logger.warning(f"⚠ Series 2 basic dashboard interaction failed")

    elif device_series == 3:
        # Series 3: Enhanced dashboard features
        logger.info(f"Series 3: Testing enhanced dashboard features")
        
        # PURE PAGE OBJECT PATTERN: Test enhanced dashboard interaction
        enhanced_dashboard = dashboard.test_enhanced_dashboard_interaction()
        if enhanced_dashboard:
            logger.info(f"✓ Series 3 enhanced dashboard interaction successful")
        else:
            logger.warning(f"⚠ Series 3 enhanced dashboard interaction failed")

    else:
        # Unknown device series - use basic validation
        logger.warning(f"Unknown device series {device_series} - using basic dashboard validation")

    # Test dashboard data persistence using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test data persistence
        persistence_valid = dashboard.validate_data_persistence()
        if persistence_valid:
            logger.info(f"✓ Dashboard data persistence validated")
        else:
            logger.warning(f"⚠ Dashboard data persistence validation failed")

    except Exception as e:
        logger.warning(f"Dashboard persistence test failed: {e}")

    # Performance validation using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Performance validation
        performance_valid = dashboard.validate_performance_expectations()
        if performance_valid:
            logger.info(f"✓ Dashboard performance passed for {device_model}")
        else:
            logger.warning(f"⚠ Dashboard performance failed for {device_model}")

    except Exception as e:
        logger.warning(f"Performance validation failed for {device_model}: {e}")

    # Test comprehensive dashboard scenarios using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test comprehensive scenarios
        comprehensive_scenarios = dashboard.test_comprehensive_dashboard_scenarios()
        if comprehensive_scenarios:
            logger.info(f"✓ Comprehensive dashboard scenarios handled")
        else:
            logger.warning(f"⚠ Some dashboard scenarios may not be handled")

    except Exception as e:
        logger.warning(f"Comprehensive dashboard test failed: {e}")

    # Log comprehensive test results using page object methods
    # PURE PAGE OBJECT PATTERN: Use page object methods instead of direct DeviceCapabilities calls
    device_info = dashboard.get_device_info()
    capabilities = dashboard.get_capabilities()

    logger.info(f"All Tables Present test completed for {device_model}")
    logger.info(f"Device info: {device_info}")
    logger.info(f"Dashboard capabilities: {capabilities}")

    print(f"ALL TABLES PRESENT VALIDATED: {device_model} (Pure Page Object Pattern)")
