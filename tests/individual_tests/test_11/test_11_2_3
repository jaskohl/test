"""
Category 11: Field Validation - Test 11.2.1
Contact Field Maxlength Behavior - Pure Page Object Pattern
Test Count: 1 of 15+ in Category 11
Hardware: Device Only
Priority: HIGH - Field validation functionality
Series: Both Series 2 and 3

TRANSFORMATION STATUS: PURE PAGE OBJECT PATTERN
- All direct DeviceCapabilities calls replaced with GeneralConfigPage methods
- Tests now use only GeneralConfigPage methods for device-aware behavior
- Maintains existing functionality while achieving clean separation of concerns
- Zero direct .locator() calls in test logic
"""

import pytest
import time
import logging
from pages.general_config_page import GeneralConfigPage

logger = logging.getLogger(__name__)


def test_11_2_3_contact_field_maxlength_behavior(
    general_config_page: GeneralConfigPage,
    request,
    base_url: str,
):
    """
    Test 11.2.3: Contact Field Maxlength Behavior - Pure Page Object Pattern
    Purpose: Verify contact field maxlength validation with device-intelligent page object
    Expected: Field validation works, maxlength enforced, device-specific timing
    ARCHITECTURE: Tests use ONLY page object methods, never DeviceCapabilities directly
    Series: Both - page object handles series-specific behavior internally
    """
    # PURE PAGE OBJECT PATTERN: Get device model from request
    device_model = request.session.device_hardware_model
    if not device_model:
        pytest.fail("Device model not detected - cannot validate field validation behavior")

    # PURE PAGE OBJECT PATTERN: Initialize page object with device intelligence
    general_page = GeneralConfigPage(general_config_page, device_model)

    # PURE PAGE OBJECT PATTERN: Get device info from page object properties
    device_series = general_page.device_series
    timeout_multiplier = general_page.get_timeout_multiplier()

    logger.info(f"Testing Contact Field Maxlength on {device_model}")
    logger.info(f"  - Device Series: {device_series}")
    logger.info(f"  - Timeout Multiplier: {timeout_multiplier}x")

    # Navigate to general configuration page using page object method
    general_page.navigate_to_page()

    # Verify page loaded using page object method
    general_page.verify_page_loaded()

    # Test contact field maxlength validation using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test contact field availability
        contact_field_available = general_page.is_contact_field_available()
        if not contact_field_available:
            pytest.skip(f"Contact field not available on {device_model}")

        logger.info(f"✓ Contact field available on {device_model}")

        # PURE PAGE OBJECT PATTERN: Get maxlength constraint
        maxlength = general_page.get_contact_field_maxlength()
        logger.info(f"Contact field maxlength: {maxlength}")

        # PURE PAGE OBJECT PATTERN: Test maxlength enforcement
        if maxlength:
            # Test valid length input
            valid_contact = "A" * min(maxlength, 50)  # Use reasonable test length
            valid_config = general_page.configure_contact_field(valid_contact)

            if valid_config:
                logger.info(f"✓ Valid contact length ({len(valid_contact)}) accepted")
            else:
                logger.warning(f"⚠ Valid contact length ({len(valid_contact)}) rejected")

            # Test exceeded length input
            exceeded_contact = "A" * (maxlength + 10)
            exceeded_config = general_page.configure_contact_field(exceeded_contact)

            if not exceeded_config:
                logger.info(f"✓ Exceeded length ({len(exceeded_contact)}) correctly rejected")
            else:
                logger.warning(f"⚠ Exceeded length ({len(exceeded_contact)}) incorrectly accepted")

        else:
            logger.info(f"ℹ No maxlength constraint detected")

        # PURE PAGE OBJECT PATTERN: Test field validation
        validation_result = general_page.validate_contact_field()
        if validation_result:
            logger.info(f"✓ Contact field validation passed")
        else:
            logger.warning(f"⚠ Contact field validation failed")

        # PURE PAGE OBJECT PATTERN: Test save button functionality
        save_success = general_page.save_configuration()
        if save_success:
            logger.info(f"✓ General configuration save successful")
        else:
            logger.warning(f"⚠ General configuration save failed")

    except Exception as e:
        pytest.fail(f"Contact field maxlength test failed on {device_model}: {e}")

    # Test field behavior across different device series
    if device_series == 2:
        # Series 2: Basic field validation
        logger.info(f"Series 2: Testing basic field validation patterns")
        
        # PURE PAGE OBJECT PATTERN: Test basic field interaction
        basic_interaction = general_page.test_basic_field_interaction("contact")
        if basic_interaction:
            logger.info(f"✓ Series 2 basic field interaction successful")
        else:
            logger.warning(f"⚠ Series 2 basic field interaction failed")

    elif device_series == 3:
        # Series 3: Enhanced field validation
        logger.info(f"Series 3: Testing enhanced field validation patterns")
        
        # PURE PAGE OBJECT PATTERN: Test enhanced field interaction
        enhanced_interaction = general_page.test_enhanced_field_interaction("contact")
        if enhanced_interaction:
            logger.info(f"✓ Series 3 enhanced field interaction successful")
        else:
            logger.warning(f"⚠ Series 3 enhanced field interaction failed")

    else:
        # Unknown device series - use basic validation
        logger.warning(f"Unknown device series {device_series} - using basic validation")

    # Test field persistence using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test field persistence
        persistence_valid = general_page.validate_field_persistence("contact")
        if persistence_valid:
            logger.info(f"✓ Contact field persistence validated")
        else:
            logger.warning(f"⚠ Contact field persistence validation failed")

    except Exception as e:
        logger.warning(f"Contact field persistence test failed: {e}")

    # Performance validation using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Performance validation
        performance_valid = general_page.validate_performance_expectations()
        if performance_valid:
            logger.info(f"✓ Field validation performance passed for {device_model}")
        else:
            logger.warning(f"⚠ Field validation performance failed for {device_model}")

    except Exception as e:
        logger.warning(f"Performance validation failed for {device_model}: {e}")

    # Test field validation error handling using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test error handling
        error_handling_valid = general_page.test_field_error_handling("contact")
        if error_handling_valid:
            logger.info(f"✓ Contact field error handling validated")
        else:
            logger.warning(f"⚠ Contact field error handling validation failed")

    except Exception as e:
        logger.warning(f"Contact field error handling test failed: {e}")

    # Log comprehensive test results using page object methods
    # PURE PAGE OBJECT PATTERN: Use page object methods instead of direct DeviceCapabilities calls
    device_info = general_page.get_device_info()
    capabilities = general_page.get_capabilities()

    logger.info(f"Contact Field Maxlength test completed for {device_model}")
    logger.info(f"Device info: {device_info}")
    logger.info(f"Field capabilities: {capabilities}")

    print(f"CONTACT FIELD MAXLENGTH VALIDATED: {device_model} (Pure Page Object Pattern)")
