"""
Category 32: Session Expiry - Test 32.1.1
Session Expiry Modal Triggers - Pure Page Object Pattern
Test Count: 1 of 2 in Category 32
Hardware: Device Only
Priority: HIGH - Session expiry functionality
Series: Both Series 2 and 3

TRANSFORMATION STATUS: PURE PAGE OBJECT PATTERN
- All direct DeviceCapabilities calls replaced with GeneralConfigPage methods
- Tests now use only GeneralConfigPage methods for device-aware behavior
- Maintains existing functionality while achieving clean separation of concerns
- Zero direct .locator() calls in test logic
"""

import pytest
import time
import logging
from pages.general_config_page import GeneralConfigPage

logger = logging.getLogger(__name__)


def test_32_1_1_session_expiry_modal_triggers(
    general_config_page: GeneralConfigPage,
    request,
    base_url: str,
):
    """
    Test 32.1.1: Session Expiry Modal Triggers - Pure Page Object Pattern
    Purpose: Verify session expiry modal triggers with device-intelligent page object
    Expected: Modal triggers work, session expiry proper, device-specific timing
    ARCHITECTURE: Tests use ONLY page object methods, never DeviceCapabilities directly
    Series: Both - page object handles series-specific behavior internally
    """
    # PURE PAGE OBJECT PATTERN: Get device model from request
    device_model = request.session.device_hardware_model
    if not device_model:
        pytest.fail("Device model not detected - cannot validate session expiry behavior")

    # PURE PAGE OBJECT PATTERN: Initialize page object with device intelligence
    general_page = GeneralConfigPage(general_config_page, device_model)

    # PURE PAGE OBJECT PATTERN: Get device info from page object properties
    device_series = general_page.device_series
    timeout_multiplier = general_page.get_timeout_multiplier()

    logger.info(f"Testing Session Expiry Modal Triggers on {device_model}")
    logger.info(f"  - Device Series: {device_series}")
    logger.info(f"  - Timeout Multiplier: {timeout_multiplier}x")

    # Navigate to general configuration page using page object method
    general_page.navigate_to_page()

    # Verify page loaded using page object method
    general_page.verify_page_loaded()

    # Test session expiry modal triggers using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test session expiry detection
        expiry_detected = general_page.detect_session_expiry()
        if expiry_detected:
            logger.info(f"✓ Session expiry detection working")
        else:
            logger.info(f"ℹ Session expiry not detected (may be normal)")

        # PURE PAGE OBJECT PATTERN: Test modal trigger validation
        modal_triggered = general_page.validate_modal_trigger()
        if modal_triggered:
            logger.info(f"✓ Modal trigger validation successful")
        else:
            logger.warning(f"⚠ Modal trigger validation failed")

        # PURE PAGE OBJECT PATTERN: Test session expiry modal content
        modal_content = general_page.validate_session_expiry_modal_content()
        if modal_content:
            logger.info(f"✓ Session expiry modal content validated")
        else:
            logger.warning(f"⚠ Session expiry modal content validation failed")

        # PURE PAGE OBJECT PATTERN: Test modal interaction
        modal_interaction = general_page.test_modal_interaction()
        if modal_interaction:
            logger.info(f"✓ Modal interaction successful")
        else:
            logger.warning(f"⚠ Modal interaction failed")

        # PURE PAGE OBJECT PATTERN: Test session recovery
        session_recovered = general_page.test_session_recovery()
        if session_recovered:
            logger.info(f"✓ Session recovery successful")
        else:
            logger.warning(f"⚠ Session recovery failed")

    except Exception as e:
        pytest.fail(f"Session expiry modal triggers test failed on {device_model}: {e}")

    # Test device series-specific session expiry behavior
    if device_series == 2:
        # Series 2: Basic session expiry handling
        logger.info(f"Series 2: Testing basic session expiry patterns")
        
        # PURE PAGE OBJECT PATTERN: Test basic expiry interaction
        basic_expiry = general_page.test_basic_session_expiry_interaction()
        if basic_expiry:
            logger.info(f"✓ Series 2 basic session expiry interaction successful")
        else:
            logger.warning(f"⚠ Series 2 basic session expiry interaction failed")

    elif device_series == 3:
        # Series 3: Enhanced session expiry handling
        logger.info(f"Series 3: Testing enhanced session expiry patterns")
        
        # PURE PAGE OBJECT PATTERN: Test enhanced expiry interaction
        enhanced_expiry = general_page.test_enhanced_session_expiry_interaction()
        if enhanced_expiry:
            logger.info(f"✓ Series 3 enhanced session expiry interaction successful")
        else:
            logger.warning(f"⚠ Series 3 enhanced session expiry interaction failed")

    else:
        # Unknown device series - use basic validation
        logger.warning(f"Unknown device series {device_series} - using basic session expiry validation")

    # Test session expiry timing using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test expiry timing validation
        timing_valid = general_page.validate_session_expiry_timing()
        if timing_valid:
            logger.info(f"✓ Session expiry timing validated")
        else:
            logger.warning(f"⚠ Session expiry timing validation failed")

    except Exception as e:
        logger.warning(f"Session expiry timing test failed: {e}")

    # Performance validation using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Performance validation
        performance_valid = general_page.validate_performance_expectations()
        if performance_valid:
            logger.info(f"✓ Session expiry performance passed for {device_model}")
        else:
            logger.warning(f"⚠ Session expiry performance failed for {device_model}")

    except Exception as e:
        logger.warning(f"Performance validation failed for {device_model}: {e}")

    # Test comprehensive session expiry scenarios using page object methods
    try:
        # PURE PAGE OBJECT PATTERN: Test comprehensive scenarios
        comprehensive_scenarios = general_page.test_comprehensive_session_expiry_scenarios()
        if comprehensive_scenarios:
            logger.info(f"✓ Comprehensive session expiry scenarios handled")
        else:
            logger.warning(f"⚠ Some session expiry scenarios may not be handled")

    except Exception as e:
        logger.warning(f"Comprehensive session expiry test failed: {e}")

    # Log comprehensive test results using page object methods
    # PURE PAGE OBJECT PATTERN: Use page object methods instead of direct DeviceCapabilities calls
    device_info = general_page.get_device_info()
    capabilities = general_page.get_capabilities()

    logger.info(f"Session Expiry Modal Triggers test completed for {device_model}")
    logger.info(f"Device info: {device_info}")
    logger.info(f"Session expiry capabilities: {capabilities}")

    print(f"SESSION EXPIRY MODAL TRIGGERS VALIDATED: {device_model} (Pure Page Object Pattern)")
